name: Daily Package Sync

on:
  schedule:
    - cron: '0 13 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´5ç‚¹è¿è¡Œ
  workflow_dispatch:  # æ·»åŠ æ‰‹åŠ¨è§¦å‘é€‰é¡¹

jobs:
  sync-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@main
        with:
          persist-credentials: true
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

      - name: Setup Git identity
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          sudo timedatectl set-timezone "PRC"

      - name: Execute sync script
        run: |
          cd $GITHUB_WORKSPACE
          chmod +x .github/diy/sync.sh  # æ·»åŠ æ‰§è¡Œæƒé™
          bash /$GITHUB_WORKSPACE/.github/diy/sync.sh

      - name: Commit changes
        id: commit
        run: |
          git add .
          if git diff --cached --quiet; then
            echo "ğŸŸ¢ No changes detected"
          else
            git commit -m "chore(packages): è‡ªåŠ¨åŒæ­¥ä»“åº“æ›´æ–° [skip ci] $(date '+%Y-%m-%d %H:%M:%S')"
            echo "ğŸŸ  Changes committed"
          fi

      - name: Push changes
        if: steps.commit.outputs.commit == 'true'
        run: git push origin HEAD:${{ github.ref }}

      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: 1

